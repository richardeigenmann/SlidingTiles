language: cpp
dist: noble
sudo: required

cache:
  directories:
    - $HOME/install_prefix

env:
  global:
   # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
   #   via the "travis encrypt" command using the project repo's public key
   - secure: "SJuH+7HAl0lSxPl34Cy7DORiH5MGc4+r3R/jSECyQqud0S+aPv9Nvd905O4WiRGjetox9OWBmAgg6uUPPoYkiIrPFEUttJW8gFdc9qyJ2+Ar29t96G2vmWtdzQFdsBzdoLO/xySHDDOQcx0kBtynCf6kp0p5U13tWVRv0XBuScDzXSyZTGY9LmLkHRJnvo/K2rksHDl4mfQvdWLR2PhoOV8tXYG5OXfSNcyy/rQU9z2G0/Eea9GbTthPTomcHzm4OdWpsS7+mpcXH0HGULyL+wkFzc9IaNUMchugTXsqyMDN0P0uQsCXlDlwl+Zau9wDPKLcx1DUxXnE0tDonjWev0zg9xHUA6Davw570Dk7f20TF9tbjK+W/ghiO5SlzEornd2BBOedt7SVQe1yML2GGv4J/kZE0l/S3QEwa1a1Qc8lOBhneHPACuqfCl/hwGGm6aSTmXTDwv1ghoJVljJ51LQM0Gp8JxyR6tPqs/57Z2oDqylPjLZ86zqaFvMcbjPcRzLYS56OoRIqjSQ1Sg6Kq7I6BMeKfcoe04PBmy3+8yhIHLpN/aosyLDSzIro9vM7Q+c/kgRDDCSDhpsgtoyXQ7gBjlapL2tMyZJ3CxFIJEQy5U7Ii2KQqdhy51ZHMymq9+his/HeU+DTLuiU343iXvX3+aIlzp9RcNtMzgqDFbY="
   - CMAKE_BUILD_PARALLEL_LEVEL=4
   - INSTALL_DIR=$HOME/install_prefix

# Test with modern compiler versions
jobs:
  include:
    - compiler: gcc
      env: SET_COMPILER="gcc-14"
    - compiler: clang
      env: SET_COMPILER="clang-18"

  # Coverity Scan moved to its own job for clarity
  allow_failures:
    - env: COVERITY_SCAN_BRANCH=1

addons:
  apt:
    packages:
      - libzmq3-dev
      - lcov
      - doxygen
      - xvfb
      - libx11-dev
      - libxcursor-dev
      - libxi-dev
      - libxrandr-dev
      - libxinerama-dev
      - libgl1-mesa-dev
      - freeglut3-dev
      - libglew-dev
      - libsndfile1-dev
      - libopenal-dev
      - libjpeg-dev
      - libfreetype6-dev
      - libflac-dev
      - libvorbis-dev
      - libogg-dev
      - libmbedtls-dev
      - libharfbuzz-dev
      - libmbedtls-dev     # For SFML Network
      - libharfbuzz-dev    # For SFML Graphics (Text Shaping)
      - libx11-xcb-dev   # <--- The "Hidden" Dependency for modern Windowing
      - libxcb1-dev      # <--- Underlying XCB headers
      - libudev-dev      # For Controller/Input device hotplugging


before_install:
  # 1. Install GCC 14 + Standard Library (Needed by both GCC and Clang)
  - |
    if [ "$SET_COMPILER" = "gcc-14" ] || [ "$SET_COMPILER" = "clang-18" ]; then
      sudo apt-get update -qq
      sudo apt-get install -y gcc-14 g++-14 libstdc++-14-dev build-essential
    fi

  # Install Clang 18 + Required Runtime for Coverage
  - |
    if [ "$SET_COMPILER" = "clang-18" ]; then
      sudo apt-get update -qq
      # We need libclang-rt-18-dev for the profiling/coverage libraries
      sudo apt-get install -y clang-18 libclang-rt-18-dev
    fi

  - if [ "$SET_COMPILER" = "gcc-14" ]; then sudo apt-get install -y gcc-14 g++-14 && export CC=gcc-14 && export CXX=g++-14; fi
  # Noble comes with Clang 18 by default or easily available
  - if [ "$SET_COMPILER" = "clang-18" ]; then sudo apt-get install -y clang-18 && export CC=clang-18 && export CXX=clang++-18; fi

  # Set compilers based on the job env
  - if [ "$SET_COMPILER" = "gcc-14" ]; then export CC=gcc-14 && export CXX=g++-14; fi
  - if [ "$SET_COMPILER" = "clang-18" ]; then export CC=clang-18 && export CXX=clang++-18; fi

  # Ensure our custom install directory exists and is in the path
  - mkdir -p $INSTALL_DIR
  - export CMAKE_PREFIX_PATH=$INSTALL_DIR:$CMAKE_PREFIX_PATH
  - export LD_LIBRARY_PATH=$INSTALL_DIR/lib:$INSTALL_DIR/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH

  # Update package list
  - sudo apt-get update -qq

  # Build GoogleTest only if not cached
  - |
    if [ ! -f "$INSTALL_DIR/lib/libgtest.a" ]; then
      git clone --depth=1 https://github.com/google/googletest.git
      cmake -S googletest -B googletest/build -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR
      cmake --build googletest/build -j4
      cmake --install googletest/build
    fi

  # Build SFML only if not cached
  - |
    if [ ! -f "$INSTALL_DIR/lib/libsfml-graphics.so" ]; then
      # Clone the specific 2.6.x branch instead of master
      git clone --depth=1 --branch 2.6.x https://github.com/SFML/SFML.git
      # git clone --depth=1 https://github.com/SFML/SFML.git
      cmake -S SFML -B SFML/build \
          -DCMAKE_C_COMPILER=$CC \
          -DCMAKE_CXX_COMPILER=$CXX \
          -DCMAKE_INSTALL_PREFIX=$INSTALL_DIR \
          -DCMAKE_BUILD_TYPE=Release \
          -DSFML_BUILD_EXAMPLES=OFF \
          -DSFML_BUILD_DOCS=OFF \
          -DSFML_INSTALL_PKGCONFIG_FILES=ON
      cmake --build SFML/build -j4
      cmake --install SFML/build
    fi

install:
  - which $CC
  - $CXX --version
  - cmake --version

script:
  - |
    if [ "${COVERITY_SCAN_BRANCH}" != 1 ]; then
      mkdir -p build && cd build
      cmake .. -DCMAKE_CXX_COMPILER=$CXX -DCMAKE_PREFIX_PATH=$INSTALL_DIR
      make -j4
      xvfb-run --server-args="-screen 0 1024x768x24" ./unit-tests --sfml-audio-mode=dummy
    fi

after_success:
  - cd ${TRAVIS_BUILD_DIR}

  # 1. Determine the correct gcov tool based on the compiler used
  - |
    if [ "$SET_COMPILER" = "gcc-14" ]; then
      export GCOV_TOOL="gcov-14"
    elif [ "$SET_COMPILER" = "clang-18" ]; then
      # Clang uses llvm-cov gcov, which is usually compatible or handled differently
      export GCOV_TOOL="llvm-cov-18 gcov"
    else
      export GCOV_TOOL="gcov"
    fi

  - lcov --directory . -base-directory . --capture -gcov-tool $GCOV_TOOL --output-file coverage.info
  - lcov --remove coverage.info '/usr/*' '*/googletest/*' '*/SFML/*' --output-file coverage.info
  # 3. Final safety: Clean any remaining absolute paths or ".." artifacts
  - sed -i "s|${TRAVIS_BUILD_DIR}/||g" coverage.info
  - sed -i "s|^\.\./||g" coverage.info
  - echo "cat coverage.info"
  - cat coverage.info
  # Modern Codecov Uploader (Replacement for the bash script)
  - curl -Os https://uploader.codecov.io/latest/linux/codecov
  - chmod +x codecov
  - ./codecov -t ${CODECOV_TOKEN}
